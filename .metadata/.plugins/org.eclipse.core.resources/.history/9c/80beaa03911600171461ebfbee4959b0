package com.taotao.portal.controller;

import java.util.List;

import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;

import com.taotao.cart.service.CartService;
import com.taotao.manager.pojo.Cart;
import com.taotao.manager.pojo.User;
import com.taotao.portal.util.CookieUtils;
import com.taotao.sso.service.UserService;

@Controller
@RequestMapping("cart")
public class CartController {

	@Value("${TT_TICKET}")
	private String TT_TICKET;

	@Autowired
	private CartService cartService;

	@Autowired
	private UserService userService;

	// 添加商品到购物车请求,直接跳转到购物车页
	// http://www.taotao.com/cart/1474391939.html?num=5
	/**
	 * 添加商品到购物车中
	 * 
	 * @param request
	 * @param itemId
	 * @param num
	 * @return
	 */
	@RequestMapping(value = "{itemId}", method = RequestMethod.GET)
	public String addItemForCart(HttpServletRequest request, @PathVariable Long itemId,
			@RequestParam(value = "num") Integer num) {
		// 获取用户登录信息
		// 获取cookie中的ticket
		String ticket = CookieUtils.getCookieValue(request, this.TT_TICKET);
		// 使用单点登录服务根据ticket查询用户登录数据
		User user = this.userService.queryUserByTicket(ticket);

		// 判断用户信息是否为空
		if (user != null) {
			// 如果不为空，表使用用户已登录
			this.cartService.addItemForCart(user.getId(), itemId, num);

		} else {
			// 如果为空，表使用用户未登录

		}

		// 重定向到购物车详情页
		return "redirect:/cart/show.html";

	}

	// 展示购物车详情
	// http://www.taotao.com/cart/show.html
	@RequestMapping(value = "show", method = RequestMethod.GET)
	public String show(Model model, HttpServletRequest request) {
		// 获取用户信息
		// 从cookie中获取ticket
		String ticket = CookieUtils.getCookieValue(request, this.TT_TICKET);
		// 使用单点登录服务根据ticket查询用户登信息
		User user = this.userService.queryUserByTicket(ticket);

		// 判断用户数据是否为空
		if (user != null) {
			// 如果不为空表示用户已登录
			List<Cart> list = this.cartService.queryCartByUserId(user.getId());
		} else {
			// 如果为空表示用户未登录

		}
		
//		把查询到的购物车放到Model中，传递给页面
		model.addAttribute("cartList", attributeValue);

		// 跳转到购物车页面
		return "cart";
	}

}
